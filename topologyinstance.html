<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Apache application heirache</title>
    <script src="js/jquery-1.11.1/jquery-1.11.1.min.js"></script>
    <!--<script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>-->
    <script src="js/jsplumb-1.7.2/dom.jsPlumb-1.7.2-min.js"></script>
    <script src="js/d3js-v3/d3.v3.min.js" charset="utf-8"></script>
    <link rel="stylesheet" href="css/style.css">
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

</head>

<body>
<h2>Apache Stratos Application Editor - Toplogy Viewer</h2>

<div class="application-topology">

</div>


</body>
<style type="text/css">

    .node rect {
        fill: #fff;
    }

    .node text { font: 12px sans-serif; }

    .link {
        fill: none;
        stroke: #ccc;
        stroke-width: 2px;
    }

    div.tooltip {
        position: absolute;
        text-align: left;
        width: 20em;
        padding: .8em;
        margin:1em;
        font: 12px sans-serif;
        background: lightsteelblue;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
    }

    .cluster{
        background-color: red;
    }
</style>
<script type="text/javascript">

var originaldata = {
    "applicationInstances":[
        {
            "applicationId":"app_boo",
            "clusterInstances":[
                {
                    "alias":"mytomcat",
                    "clusterId":"mytomcat.tomcat.domain",
                    "hostNames":[
                        "mytomcat.isuruh.lk"
                    ],
                    "instanceId":"app_boo-1",
                    "member":[
                        {
                            "clusterId":"mytomcat.tomcat.domain",
                            "memberId":"mytomcat.tomcat.domain5dd58649-0469-481e-a91e-75894069720c",
                            "memberIp":"10.0.0.5",
                            "memberPublicIp":"20.0.0.5",
                            "networkPartitionId":"openstack_R1",
                            "partitionId":"P1",
                            "property":[
                                {
                                    "name":"PRIMARY",
                                    "value":false
                                },
                                {
                                    "name":"MIN_COUNT",
                                    "value":1
                                }
                            ],
                            "serviceName":"tomcat",
                            "status":"Activated"
                        },
                        {
                            "clusterId":"mytomcat.tomcat.domain",
                            "memberId":"mytomcat.tomcat.domain368ebab7-f00e-4426-98e0-c929a0f1c6aa",
                            "memberIp":"10.0.0.10",
                            "memberPublicIp":"20.0.0.10",
                            "networkPartitionId":"openstack_R1",
                            "partitionId":"P1",
                            "property":[
                                {
                                    "name":"PRIMARY",
                                    "value":false
                                },
                                {
                                    "name":"MIN_COUNT",
                                    "value":1
                                }
                            ],
                            "serviceName":"tomcat",
                            "status":"Activated"
                        }
                    ],
                    "parentInstanceId":"app_boo-1",
                    "serviceName":"tomcat",
                    "status":"Active",
                    "tenantRange":"*"
                }
            ],
            "groupInstances":[
                {
                    "clusterInstances":[
                        {
                            "alias":"group8tom",
                            "clusterId":"group8tom.tomcat2.domain",
                            "hostNames":[
                                "group8tom.isuruh.lk"
                            ],
                            "instanceId":"app_boo-1",
                            "member":[
                                {
                                    "clusterId":"group8tom.tomcat2.domain",
                                    "memberId":"group8tom.tomcat2.domaine03864dc-d3b2-4417-adde-7ae8c76c72ca",
                                    "memberIp":"10.0.0.2",
                                    "memberPublicIp":"20.0.0.2",
                                    "networkPartitionId":"openstack_R1",
                                    "partitionId":"P1",
                                    "property":[
                                        {
                                            "name":"PRIMARY",
                                            "value":false
                                        },
                                        {
                                            "name":"MIN_COUNT",
                                            "value":1
                                        }
                                    ],
                                    "serviceName":"tomcat2",
                                    "status":"Activated"
                                },
                                {
                                    "clusterId":"group8tom.tomcat2.domain",
                                    "memberId":"group8tom.tomcat2.domainb0296d1a-4831-463a-b8a5-eae45fa9825d",
                                    "memberIp":"10.0.0.7",
                                    "memberPublicIp":"20.0.0.7",
                                    "networkPartitionId":"openstack_R1",
                                    "partitionId":"P1",
                                    "property":[
                                        {
                                            "name":"PRIMARY",
                                            "value":false
                                        },
                                        {
                                            "name":"MIN_COUNT",
                                            "value":1
                                        }
                                    ],
                                    "serviceName":"tomcat2",
                                    "status":"Activated"
                                }
                            ],
                            "parentInstanceId":"app_boo-1",
                            "serviceName":"tomcat2",
                            "status":"Active",
                            "tenantRange":"*"
                        }
                    ],
                    "groupId":"mygroup8",
                    "groupInstances":[
                        {
                            "clusterInstances":[
                                {
                                    "alias":"group9tom",
                                    "clusterId":"group9tom.tomcat1.domain",
                                    "hostNames":[
                                        "group9tom.isuruh.lk"
                                    ],
                                    "instanceId":"app_boo-1",
                                    "member":[
                                        {
                                            "clusterId":"group9tom.tomcat1.domain",
                                            "memberId":"group9tom.tomcat1.domain6dcd4cd8-1727-473d-83ff-30411050b37c",
                                            "memberIp":"10.0.0.1",
                                            "memberPublicIp":"20.0.0.1",
                                            "networkPartitionId":"openstack_R1",
                                            "partitionId":"P1",
                                            "property":[
                                                {
                                                    "name":"PRIMARY",
                                                    "value":false
                                                },
                                                {
                                                    "name":"MIN_COUNT",
                                                    "value":1
                                                }
                                            ],
                                            "serviceName":"tomcat1",
                                            "status":"Activated"
                                        },
                                        {
                                            "clusterId":"group9tom.tomcat1.domain",
                                            "memberId":"group9tom.tomcat1.domain199e4e9c-555b-4afc-a0dc-8cd277c9bf62",
                                            "memberIp":"10.0.0.6",
                                            "memberPublicIp":"20.0.0.6",
                                            "networkPartitionId":"openstack_R1",
                                            "partitionId":"P1",
                                            "property":[
                                                {
                                                    "name":"PRIMARY",
                                                    "value":false
                                                },
                                                {
                                                    "name":"MIN_COUNT",
                                                    "value":1
                                                }
                                            ],
                                            "serviceName":"tomcat1",
                                            "status":"Activated"
                                        }
                                    ],
                                    "parentInstanceId":"app_boo-1",
                                    "serviceName":"tomcat1",
                                    "status":"Active",
                                    "tenantRange":"*"
                                }
                            ],
                            "groupId":"mygroup9",
                            "instanceId":"app_boo-1",
                            "parentInstanceId":"app_boo-1",
                            "status":"Active"
                        },
                        {
                            "clusterInstances":[
                                {
                                    "alias":"group9tom",
                                    "clusterId":"group9tom.tomcat1.domain",
                                    "hostNames":[
                                        "group9tom.isuruh.lk"
                                    ],
                                    "instanceId":"app_boo-1",
                                    "member":[
                                        {
                                            "clusterId":"group9tom.tomcat1.domain",
                                            "memberId":"group9tom.tomcat1.domain6dcd4cd8-1727-473d-83ff-30411050b37c",
                                            "memberIp":"10.0.0.1",
                                            "memberPublicIp":"20.0.0.1",
                                            "networkPartitionId":"openstack_R1",
                                            "partitionId":"P1",
                                            "property":[
                                                {
                                                    "name":"PRIMARY",
                                                    "value":false
                                                },
                                                {
                                                    "name":"MIN_COUNT",
                                                    "value":1
                                                }
                                            ],
                                            "serviceName":"tomcat1",
                                            "status":"Activated"
                                        },
                                        {
                                            "clusterId":"group9tom.tomcat1.domain",
                                            "memberId":"group9tom.tomcat1.domain199e4e9c-555b-4afc-a0dc-8cd277c9bf62",
                                            "memberIp":"10.0.0.6",
                                            "memberPublicIp":"20.0.0.6",
                                            "networkPartitionId":"openstack_R1",
                                            "partitionId":"P1",
                                            "property":[
                                                {
                                                    "name":"PRIMARY",
                                                    "value":false
                                                },
                                                {
                                                    "name":"MIN_COUNT",
                                                    "value":1
                                                }
                                            ],
                                            "serviceName":"tomcat1",
                                            "status":"Activated"
                                        }
                                    ],
                                    "parentInstanceId":"app_boo-1",
                                    "serviceName":"tomcat1",
                                    "status":"Active",
                                    "tenantRange":"*"
                                }
                            ],
                            "groupId":"mygroup9-1",
                            "instanceId":"app_boo-1",
                            "parentInstanceId":"app_boo-1",
                            "status":"Active"
                        }
                    ],
                    "instanceId":"app_boo-1",
                    "parentInstanceId":"app_boo-1",
                    "status":"Active"
                },
                {
                    "clusterInstances":[
                        {
                            "alias":"group6tom",
                            "clusterId":"group6tom.tomcat2.domain",
                            "hostNames":[
                                "group6tom.isuruh.lk"
                            ],
                            "instanceId":"app_boo-1",
                            "member":[
                                {
                                    "clusterId":"group6tom.tomcat2.domain",
                                    "memberId":"group6tom.tomcat2.domaina178f042-416f-48c4-a0d6-d0792bee9232",
                                    "memberIp":"10.0.0.4",
                                    "memberPublicIp":"20.0.0.4",
                                    "networkPartitionId":"openstack_R1",
                                    "partitionId":"P1",
                                    "property":[
                                        {
                                            "name":"PRIMARY",
                                            "value":false
                                        },
                                        {
                                            "name":"MIN_COUNT",
                                            "value":1
                                        }
                                    ],
                                    "serviceName":"tomcat2",
                                    "status":"Activated"
                                },
                                {
                                    "clusterId":"group6tom.tomcat2.domain",
                                    "memberId":"group6tom.tomcat2.domain6eb8f988-fad5-4fe8-b3c5-e766f1831aef",
                                    "memberIp":"10.0.0.9",
                                    "memberPublicIp":"20.0.0.9",
                                    "networkPartitionId":"openstack_R1",
                                    "partitionId":"P1",
                                    "property":[
                                        {
                                            "name":"PRIMARY",
                                            "value":false
                                        },
                                        {
                                            "name":"MIN_COUNT",
                                            "value":1
                                        }
                                    ],
                                    "serviceName":"tomcat2",
                                    "status":"Activated"
                                }
                            ],
                            "parentInstanceId":"app_boo-1",
                            "serviceName":"tomcat2",
                            "status":"Active",
                            "tenantRange":"*"
                        }
                    ],
                    "groupId":"mygroup6",
                    "groupInstances":[
                        {
                            "clusterInstances":[
                                {
                                    "alias":"group7tom",
                                    "clusterId":"group7tom.tomcat1.domain",
                                    "hostNames":[
                                        "group7tom.isuruh.lk"
                                    ],
                                    "instanceId":"app_boo-1",
                                    "member":[
                                        {
                                            "clusterId":"group7tom.tomcat1.domain",
                                            "memberId":"group7tom.tomcat1.domain46df8a78-fb79-4698-a7d1-3a1cc3dac7b3",
                                            "memberIp":"10.0.0.3",
                                            "memberPublicIp":"20.0.0.3",
                                            "networkPartitionId":"openstack_R1",
                                            "partitionId":"P1",
                                            "property":[
                                                {
                                                    "name":"PRIMARY",
                                                    "value":false
                                                },
                                                {
                                                    "name":"MIN_COUNT",
                                                    "value":1
                                                }
                                            ],
                                            "serviceName":"tomcat1",
                                            "status":"Activated"
                                        },
                                        {
                                            "clusterId":"group7tom.tomcat1.domain",
                                            "memberId":"group7tom.tomcat1.domain88b8ff52-d6fd-49da-a556-b74eba27f046",
                                            "memberIp":"10.0.0.8",
                                            "memberPublicIp":"20.0.0.8",
                                            "networkPartitionId":"openstack_R1",
                                            "partitionId":"P1",
                                            "property":[
                                                {
                                                    "name":"PRIMARY",
                                                    "value":false
                                                },
                                                {
                                                    "name":"MIN_COUNT",
                                                    "value":1
                                                }
                                            ],
                                            "serviceName":"tomcat1",
                                            "status":"Activated"
                                        }
                                    ],
                                    "parentInstanceId":"app_boo-1",
                                    "serviceName":"tomcat1",
                                    "status":"Active",
                                    "tenantRange":"*"
                                }
                            ],
                            "groupId":"mygroup7",
                            "instanceId":"app_boo-1",
                            "parentInstanceId":"app_boo-1",
                            "status":"Active"
                        }
                    ],
                    "instanceId":"app_boo-1",
                    "parentInstanceId":"app_boo-1",
                    "status":"Active"
                }
            ],
            "instanceId":"app_boo-1",
            "status":"Active"
        },
        {
            "applicationId":"app_boo",
            "clusterInstances":[],
            "groupInstances":[],
            "instanceId":"app_boo-2",
            "status":"Active"
        }
    ],
    "id":"app_boo",
    "tenantAdminUsername":"admin",
    "tenantDomain":"carbon.super"
};

function genTree2(data) {

    var rawout = [];

    var rootnode ={};
    rootnode.name = data.id;
    rootnode.parent = null;
    //create initial root node
    rawout.push(rootnode);

    //use to get cluster nodes
    function secondorylevelclusters(item, collector, parent){
        for (var prop in item) {
            if (item.hasOwnProperty(prop)) {
                var cur_name =  item[prop].serviceName,
                        clusterId = item[prop].clusterId,
                        type = 'cluster',
                        isLbCluster = item[prop].isLbCluster;
                rawout.push({"name": clusterId, "parent": parent, "clusterId":clusterId, "type":type,
                    "isLbCluster":isLbCluster
                });
                clustermembers(item[prop].member,rawout, clusterId)
            }
        }
    }

    //use to get member nodes on cluster
    function clustermembers(item, collector, parent){
        for (var prop in item) {
            if (item.hasOwnProperty(prop)) {
                var cur_name =  item[prop].memberIp,
                        clusterId = item[prop].clusterId,
                        type = 'member',
                        memberId = item[prop].memberId,
                        status = item[prop].status,
                        memberPublicIp = item[prop].memberPublicIp,
                        partitionId = item[prop].partitionId;
                rawout.push({"name": cur_name, "parent": parent, "clusterId":clusterId, "type":type,
                    "memberId":memberId, "status": status, "memberPublicIp":memberPublicIp,
                    "partitionId":partitionId
                });
            }

        }

    }

    function secondarylevelgroups(item, collector, parent){
        for (var prop in item) {
            if (item.hasOwnProperty(prop)) {
                var cur_name =  item[prop].alias;
                console.log(cur_name)
                var type = 'groups';
                rawout.push({"name": cur_name, "parent": parent, "type":type});
                if(item[prop].hasOwnProperty('subGroups')){
                    secondarylevelgroups(item[prop].subGroups, rawout, cur_name);
                }
                secondorylevelclusters(item[prop].clusters, rawout, cur_name);

            }
        }
    }

    secondorylevelclusters(data.applications.clusters, rawout, data.applications.id);
    secondarylevelgroups(data.applications.groups, rawout, data.applications.id);
    console.log(JSON.stringify(rawout))
    return rawout;

}


function genTree(data){
    var rawout = [];

    var rootnode ={};
    rootnode.name = data.id;
    rootnode.parent = null;
    //create initial root node
    rawout.push(rootnode);

    //application instances
    function applicationInstances(items, collector, parent){
        for(var prop in items){
            if (items.hasOwnProperty(prop)) {
                var cur_name = items[prop].instanceId,
                        status = items[prop].status;
                rawout.push({"name": cur_name, "parent": parent, "status": status});

                clusterInstances(items[prop].clusterInstances, collector, cur_name);
                groupInstances(items[prop].groupInstances, collector, cur_name)
            }
        }
    }

    function clusterInstances(items, collector, parent){
        for(var prop in items){
            if (items.hasOwnProperty(prop)) {
                var cur_name = items[prop].clusterId;
                var type = 'cluster';
                rawout.push({"name": cur_name, "parent": parent, "type": type});
                clustermembers(items[prop].member, collector, cur_name)
            }
        }
    }

    function groupInstances(items, collector, parent){
        for(var prop in items){
            if (items.hasOwnProperty(prop)) {
                var cur_name = items[prop].groupId;
                var type = 'groups';
                rawout.push({"name": cur_name, "parent": parent, "type": type});

                clusterInstances(items[prop].clusterInstances, collector, cur_name);
                if(items[prop].hasOwnProperty('groupInstances')){
                    groupInstances(items[prop].groupInstances, collector, cur_name)
                }

            }
        }
    }

    function clustermembers(items, collector, parent){
        for(var prop in items){
            if (items.hasOwnProperty(prop)) {
                var cur_name = items[prop].memberId;
                var type = 'member';
                rawout.push({"name": cur_name, "parent": parent, "type": type});
            }
        }
    }

    //getting execution logic
    applicationInstances(data.applicationInstances, rawout, data.id);

    return rawout;
}


//generate tree from raw data isurudata, test_app, originaldata
var data = genTree(originaldata);
var dataMap = data.reduce(function(map, node) {
    map[node.name] = node;
    return map;
}, {});
var treeData = [];
data.forEach(function(node) {
    // add to parent
    var parent = dataMap[node.parent];
    if (parent) {
        // create child array if it doesn't exist
        (parent.children || (parent.children = []))
            // add node to child array
                .push(node);
    } else {
        // parent is null or missing
        treeData.push(node);
    }
});

console.log(treeData)

// ************** Generate the tree diagram	 *****************
var margin = {top: 40, right: 120, bottom: 20, left: 120},
        width = 960 - margin.right - margin.left,
        height = 500 - margin.top - margin.bottom;

var i = 0;

var tree = d3.layout.tree()
        .size([height, width]);

var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.x, d.y]; });

var svg = d3.select(".application-topology").append("svg")
        .attr("width", width + margin.right + margin.left)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var i = 0;
duration = 750;

root = treeData[0];

update(root);

function update(source) {

    // Compute the new tree layout.
    var nodes = tree.nodes(root).reverse(),
            links = tree.links(nodes);

    // Normalize for fixed-depth.
    nodes.forEach(function(d) { d.y = d.depth * 80; });

    // Declare the nodes…
    var node = svg.selectAll("g.node")
            .data(nodes, function(d) { return d.id || (d.id = ++i); });

    // Enter the nodes.
    var nodeEnter = node.enter().append("g")
            .attr("class", "node")
            .attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")"; })
        // add tool tip for ps -eo pid,ppid,pcpu,size,comm,ruser,s
            .on("mouseover", function(d) {
                div.transition()
                        .duration(200)
                        .style("opacity", .9);

                if(d.type == 'cluster') {
                    div.html(
                                    "<strong>Cluster ID: </strong>" + d.clusterId + "<br/>"+
                                    "<strong>Is Lb Cluster: </strong>" + d.isLbCluster
                    ).style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                }else if(d.type == 'member'){
                    div.html(
                                    "<strong>Cluster Id: </strong>" + d.clusterId + "<br/>" +
                                    "<strong>Partition Id: </strong>" + d.partitionId + "<br/>" +
                                    "<strong>Member Id: </strong>" + d.memberId + "<br/>" +
                                    "<strong>Member Public Ip: </strong>" + d.memberPublicIp
                    ).style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                }else{
                    div.html(
                                    "<strong>Alias: </strong>" + d.name + "<br/>"
                    ).style("left", (d3.event.pageX) + "px")
                            .style("top", (d3.event.pageY - 28) + "px");
                }

            })
            .on("mouseout", function(d) {
                div.transition()
                        .duration(500)
                        .style("opacity", 0);
            });

//        nodeEnter.append("circle")
//                .attr("r", 10)
//                .style("fill", "#fff");
    //add different sapes to it
    /*        nodeEnter.append("path")
     .style("stroke", "black")
     .style("fill", function(d) {
     if (d.type == 'cluster') {
     return "green";
     } else if (d.type == 'groups') {
     return "red";
     } else if (d.type == 'member'){
     return "blue";
     }else{
     return "triangle-up";
     }
     })
     .attr("d", d3.svg.symbol()
     .size(200)
     .type(function(d) {
     if (d.type == 'cluster') {
     return "circle";
     } else if (d.type == 'groups') {
     return "square";
     } else if (d.type == 'member'){
     return "diamond";
     }else{
     return "triangle-up";
     }
     }));*/
    nodeEnter.append("rect")
            .attr("x", -15)
            .attr("y", -15)
            .attr("width", 30)
            .attr("height", 30)
            .style("fill",function(d) {
                if (d.type == 'cluster') {
                    return "#e74c3c";
                } else if (d.type == 'groups') {
                    return "#2ecc71";
                } else if (d.type == 'member'){
                    return "#9b59b6";
                }else{
                    return "#1abc9c";
                }});

    nodeEnter.append("image")
            .attr( "xlink:href",
            function(d) {
                if (d.type == 'cluster') {
                    return "images/cluster.png";
                } else if (d.type == 'groups') {
                    return "images/group.png";
                } else if (d.type == 'member'){
                    return "images/member.png";
                }else{
                    return "images/application.png";
                }})
            .attr("class","created")
            .attr("x", -16)
            .attr("y", -16)
            .attr("width", 32)
            .attr("height", 32);



    nodeEnter.append("text")
            .attr("y", function(d) {
                return d.children || d._children ? -20 : 20; })
            .attr("dy", ".35em")
            .attr("text-anchor", "middle")
            .text(function(d) { return d.name; })
            .style("fill-opacity", 1);

    // add the tool tip
    var div = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

    // Declare the links…
    var link = svg.selectAll("path.link")
            .data(links, function(d) { return d.target.id; });

    // Enter the links.
    link.enter().insert("path", "g")
            .attr("class", "link")
            .attr("d", diagonal);

}

</script>


</html>